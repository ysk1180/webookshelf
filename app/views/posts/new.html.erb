<div id="preview">
  <%= image_tag 'bookshelf.png', width: 315 %>
  <span id="title_preview">
  </span>
  <span id="img1" data-title="">
    <a href="" target="_blank" id="preview_url1">
      <img src="" id="preview_image1" width="55px">
    </a>
  </span>
  <span id="img2" data-title="">
    <a href="" target="_blank" id="preview_url2">
      <img src="" id="preview_image2" width="55px">
    </a>
  </span>
  <span id="img3" data-title="">
    <a href="" target="_blank" id="preview_url3">
      <img src="" id="preview_image3" width="55px">
    </a>
  </span>
  <span id="img4" data-title="">
    <a href="" target="_blank" id="preview_url4">
      <img src="" id="preview_image4" width="55px">
    </a>
  </span>
  <span id="img5" data-title="">
    <a href="" target="_blank" id="preview_url5">
      <img src="" id="preview_image5" width="55px">
    </a>
  </span>
</div>

<div id='confirmation-button' style='display: none;'>
  <button id="save-button"><i class="fa fa-check fa-fw"></i>Twitterシェアへ</button>
</div>

<%= form_with(model: @post, local: true, id: 'not_use') do |form| %>
  <div class='form'>
    <div class="form-row">
      <div class="form-group col-3 form-text">
        １冊目
      </div>
      <div class="form-group col-9">
        <%= form.text_area :keyword1, id: :keyword1, class:'form-control', rows:"1" %>
      </div>
    </div>
    <div id="display1"></div>
    <div class="form-row">
      <div class="form-group col-3 form-text">
        ２冊目
      </div>
      <div class="form-group col-9">
        <%= form.text_area :keyword2, id: :keyword2, class:'form-control', rows:"1" %>
      </div>
    </div>
    <div id="display2"></div>
    <div class="form-row">
      <div class="form-group col-3 form-text">
        ３冊目
      </div>
      <div class="form-group col-9">
        <%= form.text_area :keyword3, id: :keyword3, class:'form-control', rows:"1" %>
      </div>
    </div>
    <div id="display3"></div>
    <div class="form-row">
      <div class="form-group col-3 form-text">
        ４冊目
      </div>
      <div class="form-group col-9">
        <%= form.text_area :keyword4, id: :keyword4, class:'form-control', rows:"1" %>
      </div>
    </div>
    <div id="display4"></div>
    <div class="form-row">
      <div class="form-group col-3 form-text">
        ５冊目
      </div>
      <div class="form-group col-9">
        <%= form.text_area :keyword5, id: :keyword5, class:'form-control', rows:"1" %>
      </div>
    </div>
    <div id="display5"></div>
    <div class="form-row">
      <div class="form-group col-3 form-text">
        タイトル
      </div>
      <div class="form-group col-9">
        <%= form.text_area :title, id: :title, value: 'わたしの本棚', class:'form-control', rows:"1" %>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group col-3 form-text">
        お名前
      </div>
      <div class="form-group col-9">
        <%= form.text_area :name, id: :name, class:'form-control', rows:"1" %>
      </div>
    </div>
  </div>
<% end %>

<script>
  function search(keyword ,index){
    if (globalTimeout != null) {
      clearTimeout(globalTimeout);
    }
    globalTimeout = setTimeout(function() {
      globalTimeout = null;

      // キーワードに入力がないときは検索しないようにする
      if (keyword === ''){
        $(`#display${index}`).css('display','none');
        return false
      };

      $.ajax({
        url: '/',
        type: 'GET',
        // jsonで返してねってこと
        dataType: 'json',
        async: true,
        data: {keyword: keyword, index: index},
      }).done(function(data){
        $(`#display${index}`).css('display', '');
        $(`#display${index}`).html(data.content);
      });

    }, 1000);
  }

  // 入力後一定時間が過ぎた後にajax処理
  // 参考にした情報：https://code.i-harness.com/ja/q/1d22c1
  var globalTimeout = null;
  $('#keyword1').keyup(function() {
    var keyword = $("#keyword1").val();
    search(keyword, 1);
  });
  $('#keyword2').keyup(function() {
    var keyword = $("#keyword2").val();
    search(keyword, 2);
  });
  $('#keyword3').keyup(function() {
    var keyword = $("#keyword3").val();
    search(keyword, 3);
  });
  $('#keyword4').keyup(function() {
    var keyword = $("#keyword4").val();
    search(keyword, 4);
  });
  $('#keyword5').keyup(function() {
    var keyword = $("#keyword5").val();
    search(keyword, 5);
  });

  $('#title').keyup(function(){
    var content = $("#title").val();
    $('#title_preview').html(content);
  });

  // 最初に表示されるように
  var content = $("#title").val();
  $('#title_preview').html(content);

  // 画像生成
  $("#save-button").on("click", function () {
    // 処理前に Loading 画像を表示
    dispLoading('BigTweet準備中...画像を作ってるよ！');

    var title1 = $('#img1').data('title');
    var image1 = $('#preview_image1').attr('src');
    var url1 = $('#preview_url1').attr('href');
    var title2 = $('#img2').data('title');
    var image2 = $('#preview_image2').attr('src');
    var url2 = $('#preview_url2').attr('href');
    var title3 = $('#img3').data('title');
    var image3 = $('#preview_image3').attr('src');
    var url3 = $('#preview_url3').attr('href');
    var title4 = $('#img4').data('title');
    var image4 = $('#preview_image4').attr('src');
    var url4 = $('#preview_url4').attr('href');
    var title5 = $('#img5').data('title');
    var image5 = $('#preview_image5').attr('src');
    var url5 = $('#preview_url5').attr('href');
    var title = $('#title').val();
    var name = $('#name').val();

    // 生成する文字列の長さ
    var l = 8;
    // 生成する文字列に含める文字セット
    var c = "abcdefghijklmnopqrstuvwxyz0123456789";
    var cl = c.length;
    var hash = "";
    for(var i=0; i<l; i++){
      hash += c[Math.floor(Math.random()*cl)];
    }

    html2canvas($('#preview').get(0), {
      proxy: true,
      useCORS: true
    }).then( function (canvas) {
      var imgData = canvas.toDataURL();

      $.ajax({
        url: '/make',
        type: 'POST',
        dataType: 'json',
        async: true,
        data: {imgData: imgData, hash: hash, title1: title1, image1: image1, url1: url1, title2: title2, image2: image2, url2: url2, title3: title3, image3: image3, url3: url3, title4: title4, image4: image4, url4: url4, title5: title5, image5: image5, url5: url5, title: title, name: name},
      }).done(function(data){
        removeLoading();
        swal({
          type: 'success',
          // title: 'Let\'s BigTweet!',
          text: '画像完成！\n↓Let\'s BigTweet!↓',
          imageUrl: `https://s3-ap-northeast-1.amazonaws.com/webookshelf-production/images/${hash}.png`,
          imageWidth: 315,
          imageAlt: 'Custom image',
          showConfirmButton: false,
          showCloseButton: true,
          footer: `<a href=https://twitter.com/share?text=%23わたしの本棚&url=https://webookshelf.herokuapp.com?h=${hash} class=share_btn2>Twitterシェア</a>`,
        })
      }).fail( function(data) {
        removeLoading();
        Swal({
          type: 'error',
          title: '画像作成に失敗しました...(; ;)',
          text: 'もう一度「がぞうをつくる」ボタンを押してみてください(> <)',
        })
      });
    });
  });

/* ------------------------------
 Loading イメージ表示関数
 引数： msg 画面に表示する文言
 ------------------------------ */
function dispLoading(msg){
  // 引数なし（メッセージなし）を許容
  if( msg == undefined ){
    msg = "";
  }
  // 画面表示メッセージ
  var dispMsg = "<div class='loadingMsg'>" + msg + "</div>";
  // ローディング画像が表示されていない場合のみ出力
  if($("#loading").length == 0){
    $("body").append("<div id='loading'>" + dispMsg + "</div>");
  }
}

/* ------------------------------
 Loading イメージ削除関数
 ------------------------------ */
function removeLoading(){
  $("#loading").remove();
}
</script>
